name: Deploy to VPS

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 72.61.227.169
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "=== Starting Deployment of branch: prod ==="

            # === SSH setup for GitHub ===
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts

            # === Start ssh-agent for git pull ===
            eval "$(ssh-agent -s)"
            ssh-add <(echo "${{ secrets.SERVER_SSH_KEY }}")

            # === Go to project ===
            cd /root/XYNAPSE_SYSTEMS

            # === Version info ===
            COMMIT_HASH=$(git rev-parse --short HEAD)
            DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            VERSION_TAG="v-${DEPLOY_TIME//[: ]/-}-$COMMIT_HASH"
            echo "Deploying version: $VERSION_TAG"

            # === Clean repo ===
            git reset --hard
            git clean -fd

            # === Git pull prod ===
            git remote set-url origin git@github.com:0rishav/XYNAPSE_SYSTEMS.git
            git fetch origin
            git checkout prod
            git pull origin prod

            # === ENV files ===
            echo "${{ secrets.BACKEND_ENV }}" > backend/.env
            echo "${{ secrets.FRONTEND_ENV }}" > frontend/.env

            # ================= BACKEND =================
            echo "=== Backend deploy ==="
            cd backend
            npm install --production

            pm2 reload xynapsesystems-backend || pm2 start index.js --name xynapsesystems-backend

            # ================= FRONTEND =================
            echo "=== Frontend build ==="
            cd ../frontend
            npm install --force
            npm run build

            # === Frontend deploy (IMPORTANT FIX) ===
            echo "=== Deploying frontend to Nginx root ==="

            mkdir -p /var/www/backups/xynapsesystems
            TIMESTAMP=$(date +%s)

            # Backup old dist
            if [ -d /var/www/xynapsesystems/dist ]; then
              cp -r /var/www/xynapsesystems/dist \
                /var/www/backups/xynapsesystems/dist-$TIMESTAMP
            fi

            # Replace dist exactly (NGINX expects this)
            rm -rf /var/www/xynapsesystems/dist
            mkdir -p /var/www/xynapsesystems/dist
            cp -r dist/* /var/www/xynapsesystems/dist/

            # Permissions for nginx
            chown -R www-data:www-data /var/www/xynapsesystems
            chmod -R 755 /var/www/xynapsesystems

            # === Reload Nginx ===
            systemctl reload nginx

            # === Log deployment ===
            echo "Deployed $VERSION_TAG at $DEPLOY_TIME" >> /root/XYNAPSE_SYSTEMS/deploy.log

            echo "=== Deployment completed successfully ==="

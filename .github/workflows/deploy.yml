name: Deploy to VPS

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 72.61.227.169
          username: root
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "=== Starting Deployment of branch: prod ==="

            # === Ensure SSH directory exists and GitHub host is trusted ===
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts

            # === Start ssh-agent and add private key ===
            eval "$(ssh-agent -s)"
            ssh-add <(echo "${{ secrets.SERVER_SSH_KEY }}")

            # === Navigate to correct project folder ===
            cd /root/XYNAPSE_SYSTEMS || exit 1

            # === Versioning and Deployment Metadata ===
            COMMIT_HASH=$(git rev-parse --short HEAD)
            DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
            VERSION_TAG="v-${DEPLOY_TIME//[: ]/-}-$COMMIT_HASH"
            echo "Version: $VERSION_TAG"

            # === Clean uncommitted changes ===
            echo "Cleaning local changes"
            git reset --hard
            git clean -fd

            # === Git operations ===
            git remote set-url origin git@github.com:0rishav/XYNAPSE_SYSTEMS.git
            echo "Fetching latest prod branch"
            git fetch origin
            git checkout prod || git checkout -b prod origin/prod
            git pull origin prod

            # === Environment variables ===
            echo "${{ secrets.BACKEND_ENV }}" > backend/.env
            echo "${{ secrets.FRONTEND_ENV }}" > frontend/.env
            # echo "${{ secrets.CHATBOT_ENV }}" > chatbot/.env

            # === Backend (Node.js + PM2) ===
            echo "Installing backend dependencies"
            cd backend
            npm install --production

            echo "Restarting PM2 backend"
            pm2 reload xynapsesystems-backend || pm2 start index.js --name xynapsesystems-backend

            # === Frontend (React/Vite) ===
            cd ../frontend
            echo "Installing frontend dependencies"
            npm install --force

            echo "Building frontend"
            npm run build

            echo "Deploying frontend to Nginx directory"
            mkdir -p /var/www/backups/xynapsesystems
            TIMESTAMP=$(date +%s)

            if [ -d /var/www/xynapsesystems ]; then
              cp -r /var/www/xynapsesystems "/var/www/backups/xynapsesystems/build-$TIMESTAMP"
            fi

            rm -rf /var/www/xynapsesystems/*
            cp -r dist/* /var/www/xynapsesystems/

            # === Reload Nginx ===
            echo "Reloading Nginx"
            systemctl reload nginx

            # === Logging deployment ===
            echo "Deployed $VERSION_TAG at $DEPLOY_TIME by GitHub Actions" >> /root/XYNAPSE_SYSTEMS/deploy.log

            echo "=== Deployment of $VERSION_TAG completed successfully ==="
